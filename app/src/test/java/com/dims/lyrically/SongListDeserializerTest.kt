package com.dims.lyrically

import android.os.Build
import androidx.arch.core.executor.testing.InstantTaskExecutorRule
import androidx.test.ext.junit.runners.AndroidJUnit4
import com.dims.lyrically.models.Song
import com.dims.lyrically.utils.SongListDeserializer
import com.google.gson.JsonElement
import com.google.gson.JsonParser
import com.nhaarman.mockitokotlin2.spy
import org.junit.Assert.assertEquals
import org.junit.Rule
import org.junit.Test
import org.junit.rules.ErrorCollector
import org.junit.runner.RunWith
import org.robolectric.annotation.Config

@RunWith(AndroidJUnit4::class)
class SongListDeserializerTest {

    @get:Rule
    val testRule = InstantTaskExecutorRule()

    //collects errors during test runs and reports them after all tests finish.
    //This ensures all your test statements to run even when prior assertions fail
    @get:Rule
    val collector = ErrorCollector()

    private val songListDeserializer = SongListDeserializer()
    private val jsonString = "{\"meta\":{\"status\":200},\"response\":{\"hits\":[{\"highlights\":[],\"index\":\"song\",\"type\":\"song\",\"result\":{\"annotation_count\":20,\"api_path\":\"/songs/3039923\",\"full_title\":\"HUMBLE. by Kendrick Lamar\",\"header_image_thumbnail_url\":\"https://images.genius.com/0780c76f8d3ab762a0ad67ac26fa9709.300x169x1.jpg\",\"header_image_url\":\"https://images.genius.com/0780c76f8d3ab762a0ad67ac26fa9709.1000x563x1.jpg\",\"id\":3039923,\"lyrics_owner_id\":104344,\"lyrics_state\":\"complete\",\"path\":\"/Kendrick-lamar-humble-lyrics\",\"pyongs_count\":1056,\"song_art_image_thumbnail_url\":\"https://images.genius.com/4387b0bcc88e07676997ba73793cc73c.300x300x1.jpg\",\"song_art_image_url\":\"https://images.genius.com/4387b0bcc88e07676997ba73793cc73c.1000x1000x1.jpg\",\"stats\":{\"unreviewed_annotations\":0,\"concurrents\":3,\"hot\":false,\"pageviews\":10606599},\"title\":\"HUMBLE.\",\"title_with_featured\":\"HUMBLE.\",\"url\":\"https://genius.com/Kendrick-lamar-humble-lyrics\",\"primary_artist\":{\"api_path\":\"/artists/1421\",\"header_image_url\":\"https://images.genius.com/f3a1149475f2406582e3531041680a3c.1000x800x1.jpg\",\"id\":1421,\"image_url\":\"https://images.genius.com/25d8a9c93ab97e9e6d5d1d9d36e64a53.1000x1000x1.jpg\",\"is_meme_verified\":true,\"is_verified\":true,\"name\":\"Kendrick Lamar\",\"url\":\"https://genius.com/artists/Kendrick-lamar\",\"iq\":42056}}},{\"highlights\":[],\"index\":\"song\",\"type\":\"song\",\"result\":{\"annotation_count\":85,\"api_path\":\"/songs/90478\",\"full_title\":\"\u200Bm.A.A.d city by Kendrick Lamar (Ft. MC Eiht)\",\"header_image_thumbnail_url\":\"https://images.genius.com/7ce90585a9da57d4ee67a09f27d8d6bc.300x300x1.jpg\",\"header_image_url\":\"https://images.genius.com/7ce90585a9da57d4ee67a09f27d8d6bc.1000x1000x1.jpg\",\"id\":90478,\"lyrics_owner_id\":103971,\"lyrics_state\":\"complete\",\"path\":\"/Kendrick-lamar-maad-city-lyrics\",\"pyongs_count\":2161,\"song_art_image_thumbnail_url\":\"https://images.genius.com/7ce90585a9da57d4ee67a09f27d8d6bc.300x300x1.jpg\",\"song_art_image_url\":\"https://images.genius.com/7ce90585a9da57d4ee67a09f27d8d6bc.1000x1000x1.jpg\",\"stats\":{\"unreviewed_annotations\":0,\"concurrents\":2,\"hot\":false,\"pageviews\":6423992},\"title\":\"\u200Bm.A.A.d city\",\"title_with_featured\":\"\u200Bm.A.A.d city (Ft. MC Eiht)\",\"url\":\"https://genius.com/Kendrick-lamar-maad-city-lyrics\",\"primary_artist\":{\"api_path\":\"/artists/1421\",\"header_image_url\":\"https://images.genius.com/f3a1149475f2406582e3531041680a3c.1000x800x1.jpg\",\"id\":1421,\"image_url\":\"https://images.genius.com/25d8a9c93ab97e9e6d5d1d9d36e64a53.1000x1000x1.jpg\",\"is_meme_verified\":true,\"is_verified\":true,\"name\":\"Kendrick Lamar\",\"url\":\"https://genius.com/artists/Kendrick-lamar\",\"iq\":42056}}},{\"highlights\":[],\"index\":\"song\",\"type\":\"song\",\"result\":{\"annotation_count\":47,\"api_path\":\"/songs/81159\",\"full_title\":\"Swimming Pools (Drank) by Kendrick Lamar\",\"header_image_thumbnail_url\":\"https://images.genius.com/08bd7e3fd36bc6cf8fca520c5e475903.300x299x1.jpg\",\"header_image_url\":\"https://images.genius.com/08bd7e3fd36bc6cf8fca520c5e475903.923x919x1.jpg\",\"id\":81159,\"lyrics_owner_id\":11524,\"lyrics_state\":\"complete\",\"path\":\"/Kendrick-lamar-swimming-pools-drank-lyrics\",\"pyongs_count\":908,\"song_art_image_thumbnail_url\":\"https://images.rapgenius.com/6ae8dfaad68e239d83a87163903257d1.300x300x1.jpg\",\"song_art_image_url\":\"https://images.rapgenius.com/6ae8dfaad68e239d83a87163903257d1.1000x1000x1.jpg\",\"stats\":{\"unreviewed_annotations\":0,\"concurrents\":2,\"hot\":false,\"pageviews\":5800905},\"title\":\"Swimming Pools (Drank)\",\"title_with_featured\":\"Swimming Pools (Drank)\",\"url\":\"https://genius.com/Kendrick-lamar-swimming-pools-drank-lyrics\",\"primary_artist\":{\"api_path\":\"/artists/1421\",\"header_image_url\":\"https://images.genius.com/f3a1149475f2406582e3531041680a3c.1000x800x1.jpg\",\"id\":1421,\"image_url\":\"https://images.genius.com/25d8a9c93ab97e9e6d5d1d9d36e64a53.1000x1000x1.jpg\",\"is_meme_verified\":true,\"is_verified\":true,\"name\":\"Kendrick Lamar\",\"url\":\"https://genius.com/artists/Kendrick-lamar\",\"iq\":42056}}},{\"highlights\":[],\"index\":\"song\",\"type\":\"song\",\"result\":{\"annotation_count\":37,\"api_path\":\"/songs/3035222\",\"full_title\":\"DNA. by Kendrick Lamar\",\"header_image_thumbnail_url\":\"https://images.genius.com/f3f77222e1b615e0a10354ea6282ff22.300x300x1.png\",\"header_image_url\":\"https://images.genius.com/f3f77222e1b615e0a10354ea6282ff22.1000x1000x1.png\",\"id\":3035222,\"lyrics_owner_id\":104344,\"lyrics_state\":\"complete\",\"path\":\"/Kendrick-lamar-dna-lyrics\",\"pyongs_count\":587,\"song_art_image_thumbnail_url\":\"https://images.genius.com/f3f77222e1b615e0a10354ea6282ff22.300x300x1.png\",\"song_art_image_url\":\"https://images.genius.com/f3f77222e1b615e0a10354ea6282ff22.1000x1000x1.png\",\"stats\":{\"unreviewed_annotations\":0,\"concurrents\":3,\"hot\":false,\"pageviews\":5435039},\"title\":\"DNA.\",\"title_with_featured\":\"DNA.\",\"url\":\"https://genius.com/Kendrick-lamar-dna-lyrics\",\"primary_artist\":{\"api_path\":\"/artists/1421\",\"header_image_url\":\"https://images.genius.com/f3a1149475f2406582e3531041680a3c.1000x800x1.jpg\",\"id\":1421,\"image_url\":\"https://images.genius.com/25d8a9c93ab97e9e6d5d1d9d36e64a53.1000x1000x1.jpg\",\"is_meme_verified\":true,\"is_verified\":true,\"name\":\"Kendrick Lamar\",\"url\":\"https://genius.com/artists/Kendrick-lamar\",\"iq\":42056}}},{\"highlights\":[],\"index\":\"song\",\"type\":\"song\",\"result\":{\"annotation_count\":25,\"api_path\":\"/songs/3047142\",\"full_title\":\"XXX. by Kendrick Lamar (Ft. U2)\",\"header_image_thumbnail_url\":\"https://images.genius.com/f3f77222e1b615e0a10354ea6282ff22.300x300x1.png\",\"header_image_url\":\"https://images.genius.com/f3f77222e1b615e0a10354ea6282ff22.1000x1000x1.png\",\"id\":3047142,\"lyrics_owner_id\":599242,\"lyrics_state\":\"complete\",\"path\":\"/Kendrick-lamar-xxx-lyrics\",\"pyongs_count\":197,\"song_art_image_thumbnail_url\":\"https://images.genius.com/f3f77222e1b615e0a10354ea6282ff22.300x300x1.png\",\"song_art_image_url\":\"https://images.genius.com/f3f77222e1b615e0a10354ea6282ff22.1000x1000x1.png\",\"stats\":{\"unreviewed_annotations\":0,\"hot\":false,\"pageviews\":4838411},\"title\":\"XXX.\",\"title_with_featured\":\"XXX. (Ft. U2)\",\"url\":\"https://genius.com/Kendrick-lamar-xxx-lyrics\",\"primary_artist\":{\"api_path\":\"/artists/1421\",\"header_image_url\":\"https://images.genius.com/f3a1149475f2406582e3531041680a3c.1000x800x1.jpg\",\"id\":1421,\"image_url\":\"https://images.genius.com/25d8a9c93ab97e9e6d5d1d9d36e64a53.1000x1000x1.jpg\",\"is_meme_verified\":true,\"is_verified\":true,\"name\":\"Kendrick Lamar\",\"url\":\"https://genius.com/artists/Kendrick-lamar\",\"iq\":42056}}},{\"highlights\":[],\"index\":\"song\",\"type\":\"song\",\"result\":{\"annotation_count\":50,\"api_path\":\"/songs/90475\",\"full_title\":\"Money Trees by Kendrick Lamar (Ft. Jay Rock)\",\"header_image_thumbnail_url\":\"https://images.genius.com/c567238c3d5781eed61a93baff46f678.300x300x1.jpg\",\"header_image_url\":\"https://images.genius.com/c567238c3d5781eed61a93baff46f678.1000x1000x1.jpg\",\"id\":90475,\"lyrics_owner_id\":1328,\"lyrics_state\":\"complete\",\"path\":\"/Kendrick-lamar-money-trees-lyrics\",\"pyongs_count\":901,\"song_art_image_thumbnail_url\":\"https://images.genius.com/c567238c3d5781eed61a93baff46f678.300x300x1.jpg\",\"song_art_image_url\":\"https://images.genius.com/c567238c3d5781eed61a93baff46f678.1000x1000x1.jpg\",\"stats\":{\"unreviewed_annotations\":1,\"concurrents\":2,\"hot\":false,\"pageviews\":4895089},\"title\":\"Money Trees\",\"title_with_featured\":\"Money Trees (Ft. Jay Rock)\",\"url\":\"https://genius.com/Kendrick-lamar-money-trees-lyrics\",\"primary_artist\":{\"api_path\":\"/artists/1421\",\"header_image_url\":\"https://images.genius.com/f3a1149475f2406582e3531041680a3c.1000x800x1.jpg\",\"id\":1421,\"image_url\":\"https://images.genius.com/25d8a9c93ab97e9e6d5d1d9d36e64a53.1000x1000x1.jpg\",\"is_meme_verified\":true,\"is_verified\":true,\"name\":\"Kendrick Lamar\",\"url\":\"https://genius.com/artists/Kendrick-lamar\",\"iq\":42056}}},{\"highlights\":[],\"index\":\"song\",\"type\":\"song\",\"result\":{\"annotation_count\":37,\"api_path\":\"/songs/90473\",\"full_title\":\"Bitch, Don't Kill My Vibe by Kendrick Lamar\",\"header_image_thumbnail_url\":\"https://images.genius.com/71de91b0a7f63cb65044ab728c0b6cef.300x300x1.jpg\",\"header_image_url\":\"https://images.genius.com/71de91b0a7f63cb65044ab728c0b6cef.1000x1000x1.jpg\",\"id\":90473,\"lyrics_owner_id\":83406,\"lyrics_state\":\"complete\",\"path\":\"/Kendrick-lamar-bitch-dont-kill-my-vibe-lyrics\",\"pyongs_count\":648,\"song_art_image_thumbnail_url\":\"https://images.genius.com/30b5f019ee61590232df42bd88d3267a.268x268x1.jpg\",\"song_art_image_url\":\"https://images.genius.com/30b5f019ee61590232df42bd88d3267a.268x268x1.jpg\",\"stats\":{\"unreviewed_annotations\":0,\"concurrents\":2,\"hot\":false,\"pageviews\":4629226},\"title\":\"Bitch, Don’t Kill My Vibe\",\"title_with_featured\":\"Bitch, Don't Kill My Vibe\",\"url\":\"https://genius.com/Kendrick-lamar-bitch-dont-kill-my-vibe-lyrics\",\"primary_artist\":{\"api_path\":\"/artists/1421\",\"header_image_url\":\"https://images.genius.com/f3a1149475f2406582e3531041680a3c.1000x800x1.jpg\",\"id\":1421,\"image_url\":\"https://images.genius.com/25d8a9c93ab97e9e6d5d1d9d36e64a53.1000x1000x1.jpg\",\"is_meme_verified\":true,\"is_verified\":true,\"name\":\"Kendrick Lamar\",\"url\":\"https://genius.com/artists/Kendrick-lamar\",\"iq\":42056}}},{\"highlights\":[],\"index\":\"song\",\"type\":\"song\",\"result\":{\"annotation_count\":34,\"api_path\":\"/songs/92856\",\"full_title\":\"Poetic Justice by Kendrick Lamar (Ft. Drake)\",\"header_image_thumbnail_url\":\"https://images.genius.com/f3db37bb8953d6e671d8bb532da2e855.220x220x1.jpg\",\"header_image_url\":\"https://images.genius.com/f3db37bb8953d6e671d8bb532da2e855.220x220x1.jpg\",\"id\":92856,\"lyrics_owner_id\":110771,\"lyrics_state\":\"complete\",\"path\":\"/Kendrick-lamar-poetic-justice-lyrics\",\"pyongs_count\":394,\"song_art_image_thumbnail_url\":\"https://images.genius.com/f3db37bb8953d6e671d8bb532da2e855.220x220x1.jpg\",\"song_art_image_url\":\"https://images.genius.com/f3db37bb8953d6e671d8bb532da2e855.220x220x1.jpg\",\"stats\":{\"unreviewed_annotations\":0,\"concurrents\":4,\"hot\":false,\"pageviews\":4277331},\"title\":\"Poetic Justice\",\"title_with_featured\":\"Poetic Justice (Ft. Drake)\",\"url\":\"https://genius.com/Kendrick-lamar-poetic-justice-lyrics\",\"primary_artist\":{\"api_path\":\"/artists/1421\",\"header_image_url\":\"https://images.genius.com/f3a1149475f2406582e3531041680a3c.1000x800x1.jpg\",\"id\":1421,\"image_url\":\"https://images.genius.com/25d8a9c93ab97e9e6d5d1d9d36e64a53.1000x1000x1.jpg\",\"is_meme_verified\":true,\"is_verified\":true,\"name\":\"Kendrick Lamar\",\"url\":\"https://genius.com/artists/Kendrick-lamar\",\"iq\":42056}}},{\"highlights\":[],\"index\":\"song\",\"type\":\"song\",\"result\":{\"annotation_count\":22,\"api_path\":\"/songs/721659\",\"full_title\":\"King Kunta by Kendrick Lamar\",\"header_image_thumbnail_url\":\"https://images.genius.com/6c4cde12a02ad49bebff62799680b04e.300x300x1.png\",\"header_image_url\":\"https://images.genius.com/6c4cde12a02ad49bebff62799680b04e.1000x1000x1.png\",\"id\":721659,\"lyrics_owner_id\":599242,\"lyrics_state\":\"complete\",\"path\":\"/Kendrick-lamar-king-kunta-lyrics\",\"pyongs_count\":1926,\"song_art_image_thumbnail_url\":\"https://images.genius.com/6c4cde12a02ad49bebff62799680b04e.300x300x1.png\",\"song_art_image_url\":\"https://images.genius.com/6c4cde12a02ad49bebff62799680b04e.1000x1000x1.png\",\"stats\":{\"unreviewed_annotations\":0,\"concurrents\":2,\"hot\":false,\"pageviews\":4185284},\"title\":\"King Kunta\",\"title_with_featured\":\"King Kunta\",\"url\":\"https://genius.com/Kendrick-lamar-king-kunta-lyrics\",\"primary_artist\":{\"api_path\":\"/artists/1421\",\"header_image_url\":\"https://images.genius.com/f3a1149475f2406582e3531041680a3c.1000x800x1.jpg\",\"id\":1421,\"image_url\":\"https://images.genius.com/25d8a9c93ab97e9e6d5d1d9d36e64a53.1000x1000x1.jpg\",\"is_meme_verified\":true,\"is_verified\":true,\"name\":\"Kendrick Lamar\",\"url\":\"https://genius.com/artists/Kendrick-lamar\",\"iq\":42056}}},{\"highlights\":[],\"index\":\"song\",\"type\":\"song\",\"result\":{\"annotation_count\":17,\"api_path\":\"/songs/3047141\",\"full_title\":\"LOVE. by Kendrick Lamar (Ft. Zacari)\",\"header_image_thumbnail_url\":\"https://images.genius.com/f3f77222e1b615e0a10354ea6282ff22.300x300x1.png\",\"header_image_url\":\"https://images.genius.com/f3f77222e1b615e0a10354ea6282ff22.1000x1000x1.png\",\"id\":3047141,\"lyrics_owner_id\":389740,\"lyrics_state\":\"complete\",\"path\":\"/Kendrick-lamar-love-lyrics\",\"pyongs_count\":224,\"song_art_image_thumbnail_url\":\"https://images.genius.com/f3f77222e1b615e0a10354ea6282ff22.300x300x1.png\",\"song_art_image_url\":\"https://images.genius.com/f3f77222e1b615e0a10354ea6282ff22.1000x1000x1.png\",\"stats\":{\"unreviewed_annotations\":0,\"concurrents\":2,\"hot\":false,\"pageviews\":3694727},\"title\":\"LOVE.\",\"title_with_featured\":\"LOVE. (Ft. Zacari)\",\"url\":\"https://genius.com/Kendrick-lamar-love-lyrics\",\"primary_artist\":{\"api_path\":\"/artists/1421\",\"header_image_url\":\"https://images.genius.com/f3a1149475f2406582e3531041680a3c.1000x800x1.jpg\",\"id\":1421,\"image_url\":\"https://images.genius.com/25d8a9c93ab97e9e6d5d1d9d36e64a53.1000x1000x1.jpg\",\"is_meme_verified\":true,\"is_verified\":true,\"name\":\"Kendrick Lamar\",\"url\":\"https://genius.com/artists/Kendrick-lamar\",\"iq\":42056}}}]}}"
    private val songs = listOf(
            Song("HUMBLE. by Kendrick Lamar", "HUMBLE.",
                    "https://images.genius.com/4387b0bcc88e07676997ba73793cc73c.300x300x1.jpg",
            "https://genius.com/Kendrick-lamar-humble-lyrics", "HUMBLE.", 3039923, "Kendrick Lamar"),
            Song("\u200Bm.A.A.d city by Kendrick Lamar (Ft. MC Eiht)", "\u200Bm.A.A.d city",
                    "https://images.genius.com/7ce90585a9da57d4ee67a09f27d8d6bc.300x300x1.jpg",
                    "https://genius.com/Kendrick-lamar-maad-city-lyrics", "\u200Bm.A.A.d city (Ft. MC Eiht)",
                    90478, "Kendrick Lamar"),
            Song("Swimming Pools (Drank) by Kendrick Lamar", "Swimming Pools (Drank)",
                    "https://images.rapgenius.com/6ae8dfaad68e239d83a87163903257d1.300x300x1.jpg",
                    "https://genius.com/Kendrick-lamar-swimming-pools-drank-lyrics", "Swimming Pools (Drank)",
                    81159, "Kendrick Lamar"),
            Song("DNA. by Kendrick Lamar", "DNA.",
                    "https://images.genius.com/f3f77222e1b615e0a10354ea6282ff22.300x300x1.png",
                    "https://genius.com/Kendrick-lamar-dna-lyrics", "DNA.", 3035222, "Kendrick Lamar"),
            Song("XXX. by Kendrick Lamar (Ft. U2)", "XXX.",
                    "https://images.genius.com/f3f77222e1b615e0a10354ea6282ff22.300x300x1.png",
                    "https://genius.com/Kendrick-lamar-xxx-lyrics", "XXX. (Ft. U2)",
                    3047142, "Kendrick Lamar"),
            Song("Money Trees by Kendrick Lamar (Ft. Jay Rock)", "Money Trees",
                    "https://images.genius.com/c567238c3d5781eed61a93baff46f678.300x300x1.jpg",
                    "https://genius.com/Kendrick-lamar-money-trees-lyrics", "Money Trees (Ft. Jay Rock)",
                    90475, "Kendrick Lamar"),
            Song("Bitch, Don't Kill My Vibe by Kendrick Lamar", "Bitch, Don’t Kill My Vibe",
                    "https://images.genius.com/30b5f019ee61590232df42bd88d3267a.268x268x1.jpg",
                    "https://genius.com/Kendrick-lamar-bitch-dont-kill-my-vibe-lyrics", "Bitch, Don't Kill My Vibe",
                    90473, "Kendrick Lamar"),
            Song("Poetic Justice by Kendrick Lamar (Ft. Drake)", "Poetic Justice",
                    "https://images.genius.com/f3db37bb8953d6e671d8bb532da2e855.220x220x1.jpg",
                    "https://genius.com/Kendrick-lamar-poetic-justice-lyrics", "Poetic Justice (Ft. Drake)",
                    92856, "Kendrick Lamar"),
            Song("King Kunta by Kendrick Lamar", "King Kunta",
                    "https://images.genius.com/6c4cde12a02ad49bebff62799680b04e.300x300x1.png",
                    "https://genius.com/Kendrick-lamar-king-kunta-lyrics", "King Kunta",
                    721659, "Kendrick Lamar"),
            Song("LOVE. by Kendrick Lamar (Ft. Zacari)", "LOVE.",
                    "https://images.genius.com/f3f77222e1b615e0a10354ea6282ff22.300x300x1.png",
                    "https://genius.com/Kendrick-lamar-love-lyrics", "LOVE. (Ft. Zacari)",
                    3047141, "Kendrick Lamar")
    )

    @Test
    @Config(sdk = [Build.VERSION_CODES.LOLLIPOP_MR1])
    fun test_deserializer_correctJson(){
        val json = JsonParser.parseString(jsonString)
        val expected = songs

        val actual = songListDeserializer.deserialize(json, null, null)

        assertEquals(expected, actual)
    }

    @Test(expected = IllegalStateException::class)
    @Config(sdk = [Build.VERSION_CODES.LOLLIPOP_MR1])
    fun test_deserializer_malformedjson(){
        val json = spy<JsonElement>(JsonParser.parseString("jsonString"))

        songListDeserializer.deserialize(json, null, null)
    }

}